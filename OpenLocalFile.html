<!DOCTYPE html>
<!-- 
Time :  2020/06/12 9:33:00 周五
Author : WeiTingjun
Description:
背景：	1. 打开文件时，目录层次太多，需要多次操作才能找到目标文件。例如：D:\Applications\Python38\Lib\site-packages\win32comext\authorization\demos；
		2. 时间长了，不清楚当初把文件放在哪个目录里；
		3. 打开无数文件资源管理器，再找目标文件时，需一个个窗口确认；
		4. 常用文件目录，每天得重复操作，耗时耗力；

提供功能：
		1. 解决以上痛点，一定程度上提高工作效率；
		2. 网页式集中管理文件目录，清晰明了；
		3. 打开文件资源管理器并选中文件夹或者文件；
		
操作指南：
		1. 将本文件放在任意位置(桌面或文件夹)；
		2. ie浏览器打开；
		3. 浏览器打开文件时，会提示“在此页上的ActiveX控件和本页上的其他部件的交互可能不安全。你想允许这种交互吗？”，点击“是”；
		   或者修改注册表，关闭该提示【注册表目录：\HKEY_CURRENT_USER\Software\Microsoft\Windows\CurrentVersion\Internet Settings\Zones\0，
		   有1201项，修改其DWORD值为零，没有1201项，空白处，右键，新建，DWORD，值为零，再重启浏览器】；
		
注意事项：
		1. 仅支持ie浏览器、windows系统；
		2. 文件夹名如果是纯数字可能会出问题(例如：D:\Applications\12)，建议修改文件夹名为非纯数字文件夹；
		3. 页面文件的同级目录不要有名为“urls.txt”文件；		
 -->
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<title>Explorer</title>
<style>

	td{
		border-bottom: 1.2px solid blue;
	}

</style>
</head>

<body  onload="load()">
<table class="table" align="center" cellspacing="0">
    <thead>
    <tr bgcolor=#96b97d style="height:22pt;">
        <th style="width:40pt;">序号</th>
        <th style="width:200pt;">简介</th>
        <th style="width:700pt;">路径</th>
        <th>操作</th>
    </tr>
    </thead>
    <tbody id="tbody">
    <tr id="row0" style="height:20pt;">
        <td class="td" align="center" style="font-size:12pt;">1</td>
        <td>
			<input id="declare0" style="border:1px;width:200pt;font-size:12pt;" placeholder="description">
		</td>
        <td>
			<input id="url0" style="border:0px;width:700pt;font-size:12pt;" placeholder="请输入文件路径，例如：C:\Program Files (x86)\Google\Temp">
		</td>
        <td>
            <input type="button" id="save0" onclick="saveUrl(this.id);" value="保存">
            <input type="button" id="open0" onclick="openFile(this.id);" value="打开">
            <input type="button" id="delete0" onclick="deleteRaw(this.id);" value="删除">
        </td>
    </tr>
    </tbody>
</table>
<div style="height:15pt;"></div>
<div align="center">
	<button style="background-color:#96b97d" onclick="plusRow();">
		新增 +
	</button>
</div>

<!--

<script src="https://cdn.bootcdn.net/ajax/libs/require.js/2.3.6/require.js"></script>

-->

<script type="text/javascript">

var UrlFileName = 'urls.txt';        //文件名

// 刷新加载  body标签 onload
function load()
{
    refresh();
}

//获取文件的相对路径
function getRelativePath(){
    var url = window.location.pathname;
    var array = url.split('/');
    var array1 = array.slice(1,-1);
    var outUrl = array1.join('/');
    return outUrl;
}

//读文件 返回str或array  根据传入的getString值判断
function getArrayOrStringByReadFile(getString){
	try{		
		if(getString==null){		
			getString=true;
		}  
		var fname = getRelativePath() + "/" + UrlFileName;
		var fso=new ActiveXObject("Scripting.FileSystemObject");
		var ForReading = 1;
		var fopen = fso.OpenTextFile(fname,ForReading,true);
		if (getString){
			var str1 = "";			
			while (!fopen.AtEndOfStream){
				str1+=fopen.ReadLine()+"\n";
				}			
			return str1;
		}
		var urlsArray = [];
		while(!fopen.AtEndOfStream){
                    urlsArray.push(fopen.ReadLine());
                }
		return urlsArray;
	}
	catch(e){
		alert("mistake when saving...");
	}
	finally{
		fopen.Close();
	}
}

// 写文件，字符串追加，数组重写
function fileWrite(args){
	try{
		var fName = getRelativePath() + "/" + UrlFileName;
		var fso=new ActiveXObject("Scripting.FileSystemObject");
		if(typeof(args) === "string"){
			var ForAppending=8;
			var fopen = fso.OpenTextFile(fName,ForAppending);
			fopen.writeLine(args);
			return true;
		}
		var ForWriting=2;  //ForReading=1以只读方式打开文件。 不能写这个文件,ForWriting=2以写方式打开文件,ForAppending=8打开文件并从文件末尾开始写
		var fopen = fso.OpenTextFile(fName,ForWriting,true);
		for(var i=0;i<args.length;i++){
			fopen.writeLine(args[i]);
		}
		return true;
	}
	catch(e){
		alert("mistake when saving...");
		return false;
	}
	finally{
		fopen.Close();
	}
}

//保存路径到文件
function saveUrl(id){
    try{
        var regexp = /[0-9]+/g;   //  /g 代表全局匹配，不是说匹配到一个就结束  /i 区分大小写
        var num = parseInt(id.match(regexp));
        var index = num+1;
        var declare = document.getElementById("declare"+num).value;
        var url = document.getElementById("url"+num).value;
        if(url==""){
            alert("Sorry, Your url isn't correct...");
        }
        else{
			var str1 = getArrayOrStringByReadFile();
            var regExp = /,[0-9]+,/g;       //隐藏一个bug，如果delare也是数字就完了，哈哈
            var indexs = str1.match(regExp);
            if(indexs !=null && indexs.indexOf(","+index+',') != -1){
				var urlsArray = getArrayOrStringByReadFile(getString=false);
                for(var i=0;i<urlsArray.length;i++){
                    var arrayIndex = urlsArray[i].match(regExp);
                    if(arrayIndex==(","+index+",")){
                        var mDeclare = document.getElementById("declare"+num).value;
                        var mUrl = document.getElementById("url"+num).value;
                        var subArr = urlsArray[i].split(',');
                        subArr.splice(2,1,mDeclare);
                        subArr.splice(3,1,mUrl);
                        var urlStr = subArr.join(',');
                        urlsArray.splice(i,1,urlStr);
						
						
						if(fileWrite(urlsArray)){
							alert("succeed...");
						}
						else{
							alert("Mistake when saving...");
						}
                        return;
                    }
                }

            }
            else{
				var urlInfo = ","+index+","+declare+","+url;
				if(fileWrite(urlInfo)){
					alert("succeed...");
				}
				else{
					alert("Mistake when saving...");
				}
            }
        }
    }
    catch(e){
           alert("Make mistakes when saving...");
    }
}

// 处理文件名中间带空格  例如：Program Files
function handleWhenUrlHasBlank(url){
    //var Array = url.split(" ");
    //var newUrl = Array.join("%20");       //文件空格用%20替换,还是不行
    //var Array1 = newUrl.split('\\');
    //var newUrl1 = '"'+Array1.join('\\\\')+'"';  //每个\\之间的文件名都加上双引号，复杂处理
    //var newUrl1 = '"'+url+'"';      // 直接“”filepath“”，简单处理
	var newUrl1 = url;
    return newUrl1;
}

// 打开指定路径文件管理弹窗
function openFile(id){
    try{
    	var regexp = /[0-9]+/g;   //  /g 代表全局匹配，不是说匹配到一个就结束  /i 区分大小写
		var num = id.match(regexp);
		var filename = document.getElementById("url"+num).value;
		if(filename==""){
		    alert("File path is null...");
		    return;
		}
        var fileName = handleWhenUrlHasBlank(filename);
		var obj=new ActiveXObject("wscript.shell");     //activex 是微软的，所以只有ie支持
		if(obj){
            //obj.Run(fileName, 1 , false );  //  ie 可以打开文件资源管理器，打开后未选中
            //obj=null;
			cmdUrl = 'explorer.exe /select,' + fileName;	//使用windows自带的explore.exe的/select参数，打开资源管理器并选中【可以不用“.exe”】
			obj.run(cmdUrl);	
		}	
    }
    catch(e){
        alert("Please make sure that url is right...");
    }
}

// 判断是否可以新增一行
function judgeIsCanAdd(){
    var t = document.getElementById("tbody");    //获取表格对象
    var rowsNom = t.rows.length;    //获取当前表格总行数
    if(document.getElementById("url"+(rowsNom-1)).value == ''){
        alert("Input previous row's file path and save...");
        return;
    }
	var str1 = getArrayOrStringByReadFile();
    var regExp = /,[0-9]+,/g;       //隐藏一个bug，如果delare也是数字就完了，哈哈
    var indexs = str1.match(regExp);
    if(indexs == null){
        alert("Please save revious row...");
        return;
    }
    if(indexs !=null && indexs.indexOf(","+rowsNom+',') == -1){
        alert("Please save revious row...");
        return;
    }
    return true;
}

// 表格新增行
plusRow = function(){
    try{
        var t = document.getElementById("tbody");    //获取表格对象
        var rowsNom = t.rows.length;    //获取当前表格总行数

       if(!judgeIsCanAdd()){
            return;
       }
        var x=t.insertRow(rowsNom);     //插入1空行 <tr></tr>
        x.innerHTML = document.getElementById("row0").innerHTML;//插入列信息
        x.getElementsByClassName("td")[0].innerHTML = rowsNom+1;  //排序
        x.id="row"+rowsNom;
        x.getElementsByTagName("td")[1].getElementsByTagName("input")[0].id="declare"+rowsNom;
        x.getElementsByTagName("td")[2].getElementsByTagName("input")[0].id="url"+rowsNom;
        x.getElementsByTagName("td")[3].getElementsByTagName("input")[0].id="save"+rowsNom;
        x.getElementsByTagName("td")[3].getElementsByTagName("input")[1].id="open"+rowsNom;
        x.getElementsByTagName("td")[3].getElementsByTagName("input")[2].id="delete"+rowsNom;
    }
    catch(e){
        alert("Make mistakes when adding...");
    }
}

//刷新页面
function refresh(){
    try{
		var urlsArray = getArrayOrStringByReadFile(getString=false);
        for(var i=0;i<urlsArray.length;i++){
                var subArray = urlsArray[i].split(',').slice(1,4);
                var index = subArray[0];
                var declare = subArray[1];
                var url = subArray[2];
                if(i==0){
                    document.getElementById("row0").getElementsByClassName("td")[0].innerHTML = index;
                    document.getElementById("declare0").value = declare;
                    document.getElementById("url0").value = url;
                }
                else{
                    plusRow();
                    document.getElementById("row"+i).getElementsByClassName("td")[0].innerHTML = index;
                    document.getElementById("declare"+i).value = declare;
                    document.getElementById("url"+i).value = url;
                }
        }
    }
    catch(e){
        alert("Make mistakes when flushing...");
    }
}

//删除一行
function deleteRaw(ID){
    try{
        var regExp = /[0-9]+/g;
        var id = parseInt(ID.match(regExp));
        var url = document.getElementById("url"+id).value;
        if(url == ""){
            alert("Can't delete...");
            return;
        }
		var urlsArray = getArrayOrStringByReadFile(getString=false);
        for(var i=0;i<urlsArray.length;i++){
            var regExp1 = /,[0-9]+,/g;
            var arrayIndex = urlsArray[i].match(regExp1);
            if(arrayIndex==(","+(id+1)+",")){
                var subArrayPre = [];
                var subArrayPos = [];
                if(i == urlsArray.length-1){
                    var newArrayUrl = urlsArray.slice(0,i);
                    break;
                }
                if(i==0){
                    subArrayPos = urlsArray.slice(i+1,urlsArray.length);
                }
                else{
                    var subArrayPre = urlsArray.slice(0,i);
                    var subArrayPos = urlsArray.slice(i+1,urlsArray.length);
                }
                for(var k=0;k<subArrayPos.length;k++){
                    var subIndex = subArrayPos[k].match(regExp1);
                    var subIndex1 = parseInt(subIndex[0].match(regExp))-1;
                    var str = subArrayPos[k].split(",");
                    str.splice(1,1,subIndex1);
                    var s = str.join(',');
                    subArrayPos.splice(k,1,s);
                }
                var newArrayUrl = subArrayPre.concat(subArrayPos);
                break;
            }
        }
        if(newArrayUrl != null){
			if(fileWrite(newArrayUrl)){
				alert("Delete succeed...");
				location.reload();
				return;
			}
			else{
				alert("Delete failed...");
			}     
        }
        alert("Url hasn't been saved...");
    }
    catch(e){
        alert("Make mistakes when deleting...");
    }
}
</script>
</body>
</html>